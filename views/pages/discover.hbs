<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">Discover Recipes</h1>
      <p class="lead">Find recipes based on your dietary preferences, ingredients, budget, and time constraints</p>
    </div>
  </div>

  {{#if message}}
  <div class="alert alert-{{#if error}}danger{{else}}success{{/if}} alert-dismissible fade show" role="alert">
    {{message}}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {{/if}}

  <!-- Search Form -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Search Preferences</h5>
    </div>
    <div class="card-body">
      <form method="POST" action="/discover/search">
        <div class="row">
          <!-- Recipe Search Query -->
          <div class="col-md-6 mb-3">
            <label for="query" class="form-label">Recipe Name or Keywords</label>
            <input type="text" class="form-control" id="query" name="query" 
                   placeholder="e.g., pasta, chicken, vegetarian" 
                   value="{{searchParams.query}}">
          </div>

          <!-- Ingredients -->
          <div class="col-md-6 mb-3">
            <label for="ingredients" class="form-label">Ingredients (comma-separated)</label>
            <input type="text" class="form-control" id="ingredients" name="ingredients" 
                   placeholder="e.g., chicken, tomatoes, pasta" 
                   value="{{searchParams.ingredients}}">
            <small class="form-text text-muted">Leave empty to search by recipe name</small>
          </div>
        </div>

        <div class="row">
          <!-- Dietary Preferences -->
          <div class="col-md-6 mb-3">
            <label for="diet" class="form-label">Dietary Preference</label>
            <select class="form-select" id="diet" name="diet">
              <option value="none" {{#if (eq searchParams.diet 'none')}}selected{{/if}}>No preference</option>
              <option value="vegetarian" {{#if (eq searchParams.diet 'vegetarian')}}selected{{/if}}>Vegetarian</option>
              <option value="vegan" {{#if (eq searchParams.diet 'vegan')}}selected{{/if}}>Vegan</option>
              <option value="gluten-free" {{#if (eq searchParams.diet 'gluten-free')}}selected{{/if}}>Gluten Free</option>
              <option value="ketogenic" {{#if (eq searchParams.diet 'ketogenic')}}selected{{/if}}>Ketogenic</option>
              <option value="pescetarian" {{#if (eq searchParams.diet 'pescetarian')}}selected{{/if}}>Pescetarian</option>
              <option value="paleo" {{#if (eq searchParams.diet 'paleo')}}selected{{/if}}>Paleo</option>
              <option value="primal" {{#if (eq searchParams.diet 'primal')}}selected{{/if}}>Primal</option>
              <option value="low-fodmap" {{#if (eq searchParams.diet 'low-fodmap')}}selected{{/if}}>Low FODMAP</option>
              <option value="whole30" {{#if (eq searchParams.diet 'whole30')}}selected{{/if}}>Whole30</option>
            </select>
          </div>

          <!-- Intolerances -->
          <div class="col-md-6 mb-3">
            <label for="intolerances" class="form-label">Intolerances (comma-separated)</label>
            <input type="text" class="form-control" id="intolerances" name="intolerances" 
                   placeholder="e.g., dairy, gluten, egg" 
                   value="{{searchParams.intolerances}}">
            <small class="form-text text-muted">Common: dairy, egg, gluten, grain, peanut, seafood, sesame, shellfish, soy, sulfite, tree-nut, wheat</small>
          </div>
        </div>

        <div class="row">
          <!-- Time Constraints -->
          <div class="col-md-4 mb-3">
            <label for="maxReadyTime" class="form-label">Max Ready Time (minutes)</label>
            <input type="number" class="form-control" id="maxReadyTime" name="maxReadyTime" 
                   min="1" max="300" placeholder="e.g., 30" 
                   value="{{searchParams.maxReadyTime}}">
          </div>

          <!-- Calorie Range -->
          <div class="col-md-4 mb-3">
            <label for="minCalories" class="form-label">Min Calories</label>
            <input type="number" class="form-control" id="minCalories" name="minCalories" 
                   min="0" placeholder="e.g., 200" 
                   value="{{searchParams.minCalories}}">
          </div>

          <div class="col-md-4 mb-3">
            <label for="maxCalories" class="form-label">Max Calories</label>
            <input type="number" class="form-control" id="maxCalories" name="maxCalories" 
                   min="0" placeholder="e.g., 800" 
                   value="{{searchParams.maxCalories}}">
          </div>
        </div>

        <div class="row">
          <!-- Budget Constraints -->
          <div class="col-md-4 mb-3">
            <label for="minPrice" class="form-label">Min Price (per serving)</label>
            <input type="number" class="form-control" id="minPrice" name="minPrice" 
                   min="0" step="0.01" placeholder="e.g., 1.00" 
                   value="{{searchParams.minPrice}}">
          </div>

          <div class="col-md-4 mb-3">
            <label for="maxPrice" class="form-label">Max Price (per serving)</label>
            <input type="number" class="form-control" id="maxPrice" name="maxPrice" 
                   min="0" step="0.01" placeholder="e.g., 10.00" 
                   value="{{searchParams.maxPrice}}">
          </div>

          <!-- Number of Results -->
          <div class="col-md-4 mb-3">
            <label for="number" class="form-label">Number of Results</label>
            <input type="number" class="form-control" id="number" name="number" 
                   min="1" max="100" value="{{#if searchParams.number}}{{searchParams.number}}{{else}}10{{/if}}">
          </div>
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary btn-lg">Search Recipes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Results Section -->
  {{#if results}}
  <form method="POST" action="/discover/grocery-list" id="groceryListForm">
    <div class="card">
      <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h5 class="mb-0">Search Results</h5>
        <button type="submit" class="btn btn-success" id="generateGroceryList" disabled>
          Generate Grocery List (<span id="selectedCount">0</span> selected)
        </button>
      </div>
      <div class="card-body">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
          {{#each results}}
          <div class="col">
            <div class="card h-100 shadow-sm">
              {{#if image}}
              <img src="{{image}}" class="card-img-top" alt="{{title}}" style="height: 200px; object-fit: cover;">
              {{/if}}
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{title}}</h5>
                {{#if (includes ../favoriteRecipeIds id)}}
                <span class="badge bg-warning text-dark w-auto mb-2">Favorited</span>
                {{/if}}

                <div class="form-check mb-3">
                  <input 
                    type="checkbox" 
                    class="form-check-input recipe-checkbox" 
                    name="recipeIds[]" 
                    value="{{id}}" 
                    id="recipe-{{id}}"
                    onchange="updateSelectedCount()">
                  <label class="form-check-label" for="recipe-{{id}}">
                    Add to grocery list
                  </label>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                  {{#if readyInMinutes}}
                  <span class="badge bg-info-subtle text-info-emphasis border border-info-subtle">
                    Ready in {{readyInMinutes}} min
                  </span>
                  {{/if}}
                  {{#if servings}}
                  <span class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle">
                    Serves {{servings}}
                  </span>
                  {{/if}}
                  {{#if pricePerServing}}
                  <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">
                    ${{pricePerServing}} / serving
                  </span>
                  {{/if}}
                </div>

                {{#if summary}}
                <p class="card-text small text-muted mb-3 flex-grow-1" style="max-height: 110px; overflow-y: auto;">
                  {{summary}}
                </p>
                {{/if}}

                {{#if nutrition}}
                <ul class="list-unstyled small text-muted mb-3">
                  {{#each nutrition.nutrients}}
                    {{#if (eq name "Calories")}}
                    <li><strong>Calories:</strong> {{amount}} kcal</li>
                    {{/if}}
                    {{#if (eq name "Protein")}}
                    <li><strong>Protein:</strong> {{amount}} {{unit}}</li>
                    {{/if}}
                    {{#if (eq name "Carbohydrates")}}
                    <li><strong>Carbs:</strong> {{amount}} {{unit}}</li>
                    {{/if}}
                    {{#if (eq name "Fat")}}
                    <li><strong>Fat:</strong> {{amount}} {{unit}}</li>
                    {{/if}}
                  {{/each}}
                </ul>
                {{/if}}

                <div class="mt-auto">
                  {{#if (includes ../favoriteRecipeIds id)}}
                  <form method="POST" action="/favorites/remove" class="mb-2">
                    <input type="hidden" name="recipeId" value="{{id}}">
                    <button type="submit" class="btn btn-sm btn-warning w-100">
                      Remove from Favorites
                    </button>
                  </form>
                  {{else}}
                  <form method="POST" action="/favorites/add" class="mb-2">
                    <input type="hidden" name="recipeId" value="{{id}}">
                    <button type="submit" class="btn btn-sm btn-outline-warning w-100">
                      Save to Favorites
                    </button>
                  </form>
                  {{/if}}
                  <a href="{{sourceUrl}}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                    View Full Recipe
                  </a>
                </div>
              </div>
            </div>
          </div>
          {{/each}}
        </div>
      </div>
    </div>
  </form>
  {{/if}}
</div>

<script>
function updateSelectedCount() {
  const selectedCountTarget = document.getElementById('selectedCount');
  const generateButton = document.getElementById('generateGroceryList');

  if (!selectedCountTarget || !generateButton) {
    return;
  }

  const checkboxes = document.querySelectorAll('.recipe-checkbox:checked');
  const count = checkboxes.length;
  selectedCountTarget.textContent = count;
  generateButton.disabled = count === 0;
}

// Initialize count on page load
document.addEventListener('DOMContentLoaded', function() {
  updateSelectedCount();
});
</script>
