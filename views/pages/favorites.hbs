<div class="container mt-4">
  <div class="row mb-3">
    <div class="col">
      <h1 class="mb-2">Favorite Recipes</h1>
      <p class="text-muted mb-0">Save go-to meals and build grocery lists from your personal cookbook.</p>
    </div>
  </div>

  {{#if message}}
  <div class="alert alert-{{#if error}}danger{{else}}info{{/if}}">
    {{message}}
  </div>
  {{/if}}

  {{#if favorites.length}}
  <form method="POST" action="/discover/grocery-list" id="favoritesGroceryForm"></form>

  <div class="card">
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
      <h5 class="mb-0">Saved Recipes</h5>
      <button 
        type="submit" 
        class="btn btn-success" 
        id="favoritesGroceryButton" 
        form="favoritesGroceryForm"
        disabled>
        Build Grocery List (<span id="favoriteSelectedCount">0</span>)
      </button>
    </div>
    <div class="card-body">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {{#each favorites}}
        <div class="col">
          <div class="card h-100 shadow-sm">
            {{#if image}}
            <img src="{{image}}" alt="{{title}}" class="card-img-top" style="height: 200px; object-fit: cover;">
            {{/if}}
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{title}}</h5>
              <div class="form-check mb-3">
                <input 
                  type="checkbox" 
                  class="form-check-input favorite-checkbox" 
                  name="recipeIds[]" 
                  value="{{id}}" 
                  id="favorite-{{id}}"
                  form="favoritesGroceryForm"
                  onchange="updateFavoriteSelectedCount()">
                <label class="form-check-label" for="favorite-{{id}}">
                  Add to grocery list
                </label>
              </div>

              <div class="d-flex flex-wrap gap-2 mb-3">
                {{#if readyInMinutes}}
                <span class="badge bg-info-subtle text-info-emphasis border border-info-subtle">
                  {{readyInMinutes}} min
                </span>
                {{/if}}
                {{#if servings}}
                <span class="badge bg-secondary-subtle text-secondary-emphasis border border-secondary-subtle">
                  Serves {{servings}}
                </span>
                {{/if}}
                {{#if pricePerServing}}
                <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">
                  ${{pricePerServing}} / serving
                </span>
                {{/if}}
                {{#if totalIngredientCost}}
                <span class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle">
                  {{formatCurrency totalIngredientCost}} total
                </span>
                {{/if}}
              </div>

              {{#if summary}}
              <p class="card-text small text-muted mb-3 flex-grow-1" style="max-height: 110px; overflow-y: auto;">
                {{summary}}
              </p>
              {{/if}}

              <div class="mt-auto">
                <form method="POST" action="/favorites/remove" class="mb-2">
                  <input type="hidden" name="recipeId" value="{{id}}">
                  <input type="hidden" name="redirectTo" value="/favorites">
                  <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                    Remove from Favorites
                  </button>
                </form>
                <a href="{{sourceUrl}}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                  View Full Recipe
                </a>
              </div>
            </div>
          </div>
        </div>
        {{/each}}
      </div>
    </div>
  </div>
  {{else}}
  <div class="text-center py-5">
    <p class="lead mb-3">You have not saved any recipes yet.</p>
    <a href="/discover" class="btn btn-primary">Start discovering recipes</a>
  </div>
  {{/if}}
</div>

<script>
function updateFavoriteSelectedCount() {
  const checkboxes = document.querySelectorAll('.favorite-checkbox:checked');
  const count = checkboxes.length;
  const countTarget = document.getElementById('favoriteSelectedCount');
  const submitButton = document.getElementById('favoritesGroceryButton');

  if (countTarget) {
    countTarget.textContent = count;
  }
  if (submitButton) {
    submitButton.disabled = count === 0;
  }
}

document.addEventListener('DOMContentLoaded', updateFavoriteSelectedCount);
</script>
